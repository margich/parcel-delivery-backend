generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

//////////////////////////
// ENUMS
//////////////////////////

enum Role {
  CUSTOMER
  COURIER
}

enum VehicleType {
  HANDCART
  BIKE
  CAR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum OrderStatus {
  CREATED
  PAID
  ACCEPTED
  ARRIVED_PICKUP
  PICKED_UP
  IN_TRANSIT
  ARRIVED_DROPOFF
  DELIVERED
  COMPLETED
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  PAYOUT
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

//////////////////////////
// USER
//////////////////////////

model User {
  id               String   @id @default(uuid())
  phoneNumber      String   @unique
  password         String
  name             String

  role             Role     @default(CUSTOMER)
  activeRole       Role     @default(CUSTOMER)

  mpesaNumber      String?

  // Customer Rating
  ratingCount      Int      @default(0)
  ratingSum        Int      @default(0)
  overallRating    Decimal  @default(5.0) @db.Decimal(3,2)

  lastLogin        DateTime?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  isDeleted        Boolean  @default(false)
  deletedAt        DateTime?

  courierProfile   CourierProfile?
  parcelRequests   ParcelRequest[] @relation("CustomerRequests")
  deliveries       ParcelRequest[] @relation("CourierDeliveries")

  reviewsGiven     Review[] @relation("Reviewer")
  reviewsReceived  Review[] @relation("Reviewee")

  savedAddresses   SavedAddress[]

  notifications    Notification[]

  @@index([phoneNumber])
}

//////////////////////////
// COURIER PROFILE
//////////////////////////

model CourierProfile {
  id                   String   @id @default(uuid())
  user                 User     @relation(fields: [userId], references: [id])
  userId               String   @unique

  vehicleType          VehicleType
  vehiclePhotoUrl      String?
  plateNumber          String?

  idCardNumber         String?
  idCardFrontPhotoUrl  String?
  idCardBackPhotoUrl   String?

  payoutMpesaNumber    String?

  isOnline             Boolean  @default(false)
  verificationStatus   VerificationStatus @default(PENDING)

  // Courier Rating
  ratingCount          Int      @default(0)
  ratingSum            Int      @default(0)
  overallRating        Decimal  @default(5.0) @db.Decimal(3,2)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  isDeleted            Boolean  @default(false)
  deletedAt            DateTime?

  wallet               Wallet?

  locations            CourierLocationHistory[]

  @@index([isOnline])
  @@index([verificationStatus])
  @@index([overallRating])
}

//////////////////////////
// COURIER LOCATION HISTORY
//////////////////////////

model CourierLocationHistory {
  id          String   @id @default(uuid())
  courierId   String
  courier     CourierProfile @relation(fields: [courierId], references: [id])

  lat         Float
  lng         Float
  createdAt   DateTime @default(now())

  @@index([courierId])
  @@index([createdAt])
}

//////////////////////////
// WALLET (Audit Safe)
//////////////////////////

model Wallet {
  id              String   @id @default(uuid())
  courier         CourierProfile @relation(fields: [courierId], references: [id])
  courierId       String   @unique

  balance         Decimal  @default(0.0) @db.Decimal(12,2)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  ledgerEntries   WalletLedger[]
}

model WalletLedger {
  id          String   @id @default(uuid())
  wallet      Wallet   @relation(fields: [walletId], references: [id])
  walletId    String

  type        TransactionType
  amount      Decimal  @db.Decimal(12,2)
  balanceAfter Decimal @db.Decimal(12,2)

  reference   String?  // M-Pesa reference or order ID
  createdAt   DateTime @default(now())

  @@index([walletId])
}

//////////////////////////
// PARCEL REQUEST
//////////////////////////

model ParcelRequest {
  id               String   @id @default(uuid())

  customer         User     @relation("CustomerRequests", fields: [customerId], references: [id])
  customerId       String

  courier          User?    @relation("CourierDeliveries", fields: [courierId], references: [id])
  courierId        String?

  pickupAddress    String
  pickupLat        Float
  pickupLng        Float

  dropoffAddress   String
  dropoffLat       Float
  dropoffLng       Float

  vehicleType      VehicleType
  packageType      String
  instructions     String?

  parcelPhotoUrl   String?
  pickupPhotoUrl   String?
  deliveryPhotoUrl String?

  // Fare breakdown
  fixedPrice       Decimal @db.Decimal(12,2)  // Price based on vehicle type
  platformFee      Decimal @db.Decimal(12,2)  // Commission taken by platform
  courierEarning   Decimal @db.Decimal(12,2)  // fixedPrice - platformFee
  totalPrice       Decimal @db.Decimal(12,2)  // For display, usually same as fixedPrice

  status           OrderStatus @default(CREATED)

  expiresAt        DateTime?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  isDeleted        Boolean  @default(false)
  deletedAt        DateTime?

  transactions     Transaction[]
  reviews          Review[]
  statusHistory    OrderStatusHistory[]

  @@index([status])
  @@index([courierId])
  @@index([customerId])
  @@index([pickupLat, pickupLng])
  @@index([dropoffLat, dropoffLng])
  @@index([expiresAt])
}

//////////////////////////
// ORDER STATUS HISTORY
//////////////////////////

model OrderStatusHistory {
  id              String   @id @default(uuid())
  parcelRequest   ParcelRequest @relation(fields: [parcelRequestId], references: [id])
  parcelRequestId String
  status          OrderStatus
  createdAt       DateTime @default(now())

  @@index([parcelRequestId])
}

//////////////////////////
// TRANSACTIONS
//////////////////////////

model Transaction {
  id              String   @id @default(uuid())
  parcelRequest   ParcelRequest? @relation(fields: [parcelRequestId], references: [id])
  parcelRequestId String?

  mpesaReference  String?  @unique
  type            TransactionType
  amount          Decimal  @db.Decimal(12,2)
  status          TransactionStatus @default(PENDING)

  phoneNumber     String

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  gatewayResponse Json?
  failureReason   String?

  @@index([parcelRequestId])
  @@index([status])
}

//////////////////////////
// REVIEWS
//////////////////////////

model Review {
  id              String   @id @default(uuid())
  parcelRequest   ParcelRequest @relation(fields: [parcelRequestId], references: [id])
  parcelRequestId String

  fromUser        User     @relation("Reviewer", fields: [fromUserId], references: [id])
  fromUserId      String

  toUser          User     @relation("Reviewee", fields: [toUserId], references: [id])
  toUserId        String

  rating          Int
  comment         String?

  createdAt       DateTime @default(now())

  @@unique([parcelRequestId, fromUserId])
  @@index([toUserId])
}

//////////////////////////
// SAVED ADDRESSES
//////////////////////////

model SavedAddress {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String

  label     String
  address   String
  lat       Float?
  lng       Float?

  createdAt DateTime @default(now())

  @@index([userId])
}

//////////////////////////
// NOTIFICATIONS
//////////////////////////

model Notification {
  id        String @id @default(uuid())
  user      User   @relation(fields: [userId], references: [id])
  userId    String
  type      String
  title     String
  body      String
  read      Boolean @default(false)
  createdAt DateTime @default(now())

  @@index([userId, read])
}