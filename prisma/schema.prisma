// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  CUSTOMER
  COURIER
}

enum VehicleType {
  HANDCART
  BIKE
  CAR
}

enum VerificationStatus {
  PENDING
  VERIFIED
  REJECTED
}

enum OrderStatus {
  CREATED
  PAID
  ACCEPTED
  ARRIVED_PICKUP
  PICKED_UP
  IN_TRANSIT
  ARRIVED_DROPOFF
  DELIVERED
  COMPLETED
  CANCELLED
}

enum TransactionType {
  DEPOSIT
  PAYOUT
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

model User {
  id            String    @id @default(uuid())
  phoneNumber   String    @unique
  password      String
  name          String
  role          Role      @default(CUSTOMER)
  activeRole    Role      @default(CUSTOMER)
  defaultRole   Role      @default(CUSTOMER)
  mpesaNumber   String?
  overallRating Float     @default(5.0)
  lastLogin     DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  courierProfile CourierProfile?
  parcelRequests ParcelRequest[] @relation("CustomerRequests")
  deliveries     ParcelRequest[] @relation("CourierDeliveries")
  reviewsGiven   Review[]        @relation("Reviewer")
  reviewsReceived Review[]       @relation("Reviewee")
  savedAddresses SavedAddress[]
}

model CourierProfile {
  id                 String             @id @default(uuid())
  user               User               @relation(fields: [userId], references: [id])
  userId             String             @unique
  vehicleType        VehicleType
  vehiclePhotoUrl    String?
  plateNumber        String?
  idCardPhotoUrl     String?
  isOnline           Boolean            @default(false)
  latitude           Float?
  longitude          Float?
  walletBalance      Float              @default(0.0)
  verificationStatus VerificationStatus @default(PENDING)
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

model ParcelRequest {
  id                String      @id @default(uuid())
  customer          User        @relation("CustomerRequests", fields: [customerId], references: [id])
  customerId        String
  courier           User?       @relation("CourierDeliveries", fields: [courierId], references: [id])
  courierId         String?
  
  pickupAddress     String
  pickupLat         Float
  pickupLng         Float
  dropoffAddress    String
  dropoffLat        Float
  dropoffLng        Float
  
  vehicleType       VehicleType
  packageType       String
  instructions      String?
  
  parcelPhotoUrl    String?
  pickupPhotoUrl    String?
  deliveryPhotoUrl  String?
  
  price             Float
  status            OrderStatus @default(CREATED)
  
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  
  transactions      Transaction[]
  reviews           Review[]
}

model Transaction {
  id              String            @id @default(uuid())
  parcelRequest   ParcelRequest     @relation(fields: [parcelRequestId], references: [id])
  parcelRequestId String
  mpesaReference  String?           @unique
  type            TransactionType
  amount          Float
  status          TransactionStatus @default(PENDING)
  phoneNumber     String
  createdAt       DateTime          @default(now())
}

model Review {
  id              String        @id @default(uuid())
  parcelRequest   ParcelRequest @relation(fields: [parcelRequestId], references: [id])
  parcelRequestId String
  fromUser        User          @relation("Reviewer", fields: [fromUserId], references: [id])
  fromUserId      String
  toUser          User          @relation("Reviewee", fields: [toUserId], references: [id])
  toUserId        String
  rating          Int
  comment         String?
  createdAt       DateTime      @default(now())
}

model SavedAddress {
  id          String   @id @default(uuid())
  user        User     @relation(fields: [userId], references: [id])
  userId      String
  label       String
  address     String
  lat         Float?
  lng         Float?
  createdAt   DateTime @default(now())
}
